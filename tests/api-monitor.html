<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Performance Monitor</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #569cd6;
            font-size: 14px;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #4ec9b0;
        }
        .stat-card .label {
            font-size: 12px;
            color: #858585;
            margin-top: 5px;
        }
        .warning {
            color: #f48771 !important;
        }
        .good {
            color: #4ec9b0 !important;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        button.danger {
            background: #c72e0f;
        }
        button.danger:hover {
            background: #e03e1e;
        }
        .timeline {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .timeline h3 {
            margin: 0 0 15px 0;
            color: #569cd6;
        }
        .api-call {
            padding: 8px;
            margin: 5px 0;
            background: #1e1e1e;
            border-left: 3px solid #4ec9b0;
            font-size: 12px;
        }
        .api-call.duplicate {
            border-left-color: #f48771;
        }
        .api-call .method {
            display: inline-block;
            width: 60px;
            font-weight: bold;
            color: #dcdcaa;
        }
        .api-call .url {
            color: #9cdcfe;
        }
        .api-call .size {
            color: #ce9178;
            margin-left: 10px;
        }
        .api-call .time {
            color: #858585;
            margin-left: 10px;
        }
        .endpoint-list {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .endpoint-list h3 {
            margin: 0 0 15px 0;
            color: #569cd6;
        }
        .endpoint-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #1e1e1e;
            font-size: 12px;
        }
        .endpoint-item .endpoint {
            color: #9cdcfe;
            flex: 1;
        }
        .endpoint-item .count {
            color: #b5cea8;
            font-weight: bold;
            margin-left: 10px;
        }
        .endpoint-item.duplicate {
            background: #3a1f1f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç API Performance Monitor</h1>
        
        <div class="controls">
            <button onclick="startMonitoring()">‚ñ∂Ô∏è Start Monitoring</button>
            <button onclick="stopMonitoring()">‚è∏Ô∏è Stop Monitoring</button>
            <button onclick="resetMonitoring()" class="danger">üîÑ Reset</button>
            <button onclick="exportReport()">üìä Export Report</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Total API Calls</h3>
                <div class="value" id="totalCalls">0</div>
                <div class="label">Since monitoring started</div>
            </div>
            <div class="stat-card">
                <h3>Data Transferred</h3>
                <div class="value" id="totalData">0 KB</div>
                <div class="label">Total response size</div>
            </div>
            <div class="stat-card">
                <h3>Monitoring Duration</h3>
                <div class="value" id="duration">0s</div>
                <div class="label">Time elapsed</div>
            </div>
            <div class="stat-card">
                <h3>Duplicate Calls</h3>
                <div class="value warning" id="duplicates">0</div>
                <div class="label">Same endpoint called multiple times</div>
            </div>
        </div>

        <div class="endpoint-list">
            <h3>üìç Calls by Endpoint</h3>
            <div id="endpointList"></div>
        </div>

        <div class="timeline">
            <h3>‚è±Ô∏è API Call Timeline (Last 50)</h3>
            <div id="timeline"></div>
        </div>
    </div>

    <script>
        let apiCalls = [];
        let monitoring = false;
        let startTime = null;
        let originalFetch = null;
        let durationInterval = null;

        function startMonitoring() {
            if (monitoring) return;
            
            monitoring = true;
            startTime = Date.now();
            apiCalls = [];
            
            // Intercept fetch
            if (!originalFetch) {
                originalFetch = window.fetch;
            }
            
            window.fetch = async function(...args) {
                const callStartTime = Date.now();
                const url = args[0];
                const options = args[1] || {};
                
                try {
                    const response = await originalFetch.apply(this, args);
                    
                    // Clone response to read body
                    const clonedResponse = response.clone();
                    const body = await clonedResponse.text();
                    const responseSize = new Blob([body]).size;
                    
                    if (monitoring && url.includes('/api/')) {
                        apiCalls.push({
                            url: url,
                            method: options.method || 'GET',
                            timestamp: callStartTime,
                            responseSize: responseSize,
                            duration: Date.now() - callStartTime,
                            status: response.status
                        });
                        
                        updateDisplay();
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Fetch error:', error);
                    throw error;
                }
            };
            
            // Update duration every second
            durationInterval = setInterval(updateDuration, 1000);
            
            console.log('‚úÖ API Monitoring started');
            updateDisplay();
        }

        function stopMonitoring() {
            monitoring = false;
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
            console.log('‚è∏Ô∏è API Monitoring stopped');
        }

        function resetMonitoring() {
            stopMonitoring();
            apiCalls = [];
            startTime = null;
            
            // Restore original fetch
            if (originalFetch) {
                window.fetch = originalFetch;
            }
            
            updateDisplay();
            console.log('üîÑ API Monitoring reset');
        }

        function updateDuration() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('duration').textContent = elapsed + 's';
            }
        }

        function updateDisplay() {
            // Total calls
            document.getElementById('totalCalls').textContent = apiCalls.length;
            
            // Total data
            const totalBytes = apiCalls.reduce((sum, call) => sum + call.responseSize, 0);
            document.getElementById('totalData').textContent = formatBytes(totalBytes);
            
            // Duration
            updateDuration();
            
            // Count by endpoint
            const endpointCounts = new Map();
            apiCalls.forEach(call => {
                const url = new URL(call.url);
                const endpoint = url.pathname;
                endpointCounts.set(endpoint, (endpointCounts.get(endpoint) || 0) + 1);
            });
            
            // Duplicates
            let duplicateCount = 0;
            endpointCounts.forEach(count => {
                if (count > 1) duplicateCount++;
            });
            document.getElementById('duplicates').textContent = duplicateCount;
            
            // Endpoint list
            const endpointListHtml = Array.from(endpointCounts.entries())
                .sort((a, b) => b[1] - a[1])
                .map(([endpoint, count]) => {
                    const isDuplicate = count > 1;
                    return `<div class="endpoint-item ${isDuplicate ? 'duplicate' : ''}">
                        <span class="endpoint">${endpoint}</span>
                        <span class="count">${count} ${count > 1 ? '‚ö†Ô∏è' : ''}</span>
                    </div>`;
                })
                .join('');
            document.getElementById('endpointList').innerHTML = endpointListHtml || '<div style="color: #858585;">No API calls yet</div>';
            
            // Timeline (last 50)
            const timelineHtml = apiCalls.slice(-50).reverse().map((call, index) => {
                const url = new URL(call.url);
                const relativeTime = startTime ? ((call.timestamp - startTime) / 1000).toFixed(2) : '0.00';
                return `<div class="api-call">
                    <span class="method">${call.method}</span>
                    <span class="url">${url.pathname}</span>
                    <span class="size">${formatBytes(call.responseSize)}</span>
                    <span class="time">+${relativeTime}s (${call.duration}ms)</span>
                </div>`;
            }).join('');
            document.getElementById('timeline').innerHTML = timelineHtml || '<div style="color: #858585;">No API calls yet</div>';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function exportReport() {
            const report = {
                totalCalls: apiCalls.length,
                totalDataTransferred: apiCalls.reduce((sum, call) => sum + call.responseSize, 0),
                duration: startTime ? (Date.now() - startTime) / 1000 : 0,
                calls: apiCalls
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `api-report-${new Date().toISOString()}.json`;
            a.click();
            
            console.log('üìä Report exported');
        }

        // Auto-start monitoring
        console.log('üîç API Performance Monitor loaded');
        console.log('üìù Instructions:');
        console.log('   1. Click "Start Monitoring" button');
        console.log('   2. Navigate to http://localhost:3000 and login');
        console.log('   3. Wait 30 seconds without clicking anything');
        console.log('   4. Check the stats and timeline');
        console.log('   5. Click "Export Report" to save data');
    </script>
</body>
</html>

